<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  
    <title>Bhyve Part 1 :: GSoC 25: Roadmap</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Quick Architectural Walkthrough of FreeBSD Bhyve" />
<meta name="keywords" content="Bhyve, FreeBSD" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="http://localhost:1313/posts/bhyve-part-1/" />







  
  
  
  
  
  <link rel="stylesheet" href="http://localhost:1313/styles.css">







  <link rel="shortcut icon" href="http://localhost:1313/img/theme-colors/orange.png">
  <link rel="apple-touch-icon" href="http://localhost:1313/img/theme-colors/orange.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Bhyve Part 1">
<meta property="og:description" content="Quick Architectural Walkthrough of FreeBSD Bhyve" />
<meta property="og:url" content="http://localhost:1313/posts/bhyve-part-1/" />
<meta property="og:site_name" content="GSoC 25: Roadmap" />

  
  
  <meta property="og:image" content="http://localhost:1313/">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2025-05-13 09:33:23 -0400 EDT" />













  


</head>
<body class="orange">




<div class="container headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="http://localhost:1313/">
  <div class="logo">
    re-Terminal
  </div>
</a>

    </div>
    
    
  </div>
  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="http://localhost:1313/posts/bhyve-part-1/">Bhyve Part 1</a>
  </h1>
  <div class="post-meta"><time class="post-date">2025-05-13</time><span class="post-author">Abhinav Chavali</span>
    
</div>

  
    <span class="post-tags">
      
      #<a href="http://localhost:1313/tags/bhyve/">Bhyve</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/freebsd/">FreeBSD</a>&nbsp;
      
    </span>
  
  



  
    <div class="table-of-contents">
      <h2>
        Table of Contents
      </h2>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#using-bhyve-and-bhyve-firmware">Using Bhyve and <code>bhyve-firmware</code></a></li>
    <li><a href="#bhyve-internals-amd64">Bhyve Internals (amd64)</a>
      <ul>
        <li><a href="#main-function">Main Function</a></li>
      </ul>
    </li>
    <li><a href="#sources">Sources</a></li>
  </ul>
</nav>
    </div>
  

  <div class="post-content"><div>
        <h2 id="using-bhyve-and-bhyve-firmware">Using Bhyve and <code>bhyve-firmware</code><a href="#using-bhyve-and-bhyve-firmware" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Ensure <code>vmm.ko</code> is loaded and <code>bhyve-firmware</code> is installed:</p>
<pre tabindex="0"><code># kldstat -m vmm
# pkg install bhyve-firmware
</code></pre><p>Create bridge as described <a href="https://docs.freebsd.org/en/books/handbook/virtualization/#virtualization-bhyve-prep">here</a></p>
<p>Create VM:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># bhyve -c 2 -m 2G -AHP -s 0:0,hostbridge -s 31,lpc \</span>
</span></span><span style="display:flex;"><span>    -s 3:0,ahci-hd,<span style="color:#e6db74">${</span>BACKING_FILE<span style="color:#e6db74">}</span>.img <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -l com1,stdio <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -l bootrom,/usr/local/share/uefi-firmware/BHYVE_UEFI.fd <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -s 2,virtio-net,tap0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    vm0
</span></span></code></pre></div><p>This command:</p>
<ul>
<li><code>c 2</code>: Attaches 2 virtual CPUs</li>
<li><code>m 2G</code>: Allocates 2G of RAM</li>
<li><code>AHP</code>: Enables, ACPI, Hypervisor, and host CPU vendor</li>
<li><code>-s </code>: PCI device assignments (slot:function)</li>
</ul>
<h2 id="bhyve-internals-amd64">Bhyve Internals (amd64)<a href="#bhyve-internals-amd64" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="main-function">Main Function<a href="#main-function" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<ol>
<li>Initialize configuration</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> bhyverun.<span style="color:#a6e22e">c</span> (<span style="color:#ae81ff">638</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">bhyve_init_config</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">bhyve_optparse</span>(argc, argv);
</span></span></code></pre></div><p>These functions just set the configuration options for Bhyve by parsing the command line arguments. For example, the <code>pci</code> devices are parsed as such:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> bhyverun_machdep.<span style="color:#a6e22e">c</span> (<span style="color:#ae81ff">183</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;s&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strncmp</span>(optarg, <span style="color:#e6db74">&#34;help&#34;</span>, <span style="color:#a6e22e">strlen</span>(optarg)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">pci_print_supported_devices</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">pci_parse_slot</span>(optarg) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span></code></pre></div><ol start="2">
<li>Calculate Topology and Build vCPU Maps</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>    <span style="color:#a6e22e">calc_topology</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">build_vcpumaps</span>();
</span></span></code></pre></div><p><code>calc_topology</code> makes sure the sockets, cores, threads, and guest cpu variables are valid and set.
<code>build_vcpumaps</code> allocates a <code>vcpumap</code>. A <code>vcpumap</code> is just a double pointer to a <code>cpuset</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">cpuset_t</span> <span style="color:#f92672">**</span>vcpumap;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Each vcpu gets a cpuset
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	vcpumap <span style="color:#f92672">=</span> <span style="color:#a6e22e">calloc</span>(guest_ncpus, <span style="color:#66d9ef">sizeof</span>(<span style="color:#f92672">*</span>vcpumap));
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> (vcpu <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; vcpu <span style="color:#f92672">&lt;</span> guest_ncpus; vcpu<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">snprintf</span>(key, <span style="color:#66d9ef">sizeof</span>(key), <span style="color:#e6db74">&#34;vcpu.%d.cpuset&#34;</span>, vcpu);
</span></span><span style="display:flex;"><span>		value <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_config_value</span>(key);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (value <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>		vcpumap[vcpu] <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">cpuset_t</span>));
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (vcpumap[vcpu] <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">err</span>(<span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#34;Failed to allocate cpuset for vcpu %d&#34;</span>, vcpu);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">parse_cpuset</span>(vcpu, value, vcpumap[vcpu]);
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></div><ol start="3">
<li>Creating the VM
Creating the VM is done in the <code>do_open</code> function.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> vmctx <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">do_open</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>vmname)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> vmctx <span style="color:#f92672">*</span>ctx;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> error;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">bool</span> romboot;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	romboot <span style="color:#f92672">=</span> <span style="color:#a6e22e">bootrom_boot</span>(); <span style="color:#75715e">/* Is there a bootrom? */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * If we don&#39;t have a boot ROM, the guest context must have been
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * initialized by bhyveload(8) or equivalent.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 */</span>
</span></span><span style="display:flex;"><span>	ctx <span style="color:#f92672">=</span> <span style="color:#a6e22e">vm_openf</span>(vmname, romboot <span style="color:#f92672">?</span> VMMAPI_OPEN_REINIT : <span style="color:#ae81ff">0</span>); <span style="color:#75715e">// From Libvmmapi
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (ctx <span style="color:#f92672">==</span> NULL) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (errno <span style="color:#f92672">!=</span> ENOENT)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">err</span>(<span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#34;vm_openf&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>romboot)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">errx</span>(<span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#34;no bootrom was configured&#34;</span>);
</span></span><span style="display:flex;"><span>		ctx <span style="color:#f92672">=</span> <span style="color:#a6e22e">vm_openf</span>(vmname, VMMAPI_OPEN_CREATE);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (ctx <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">err</span>(<span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#34;vm_openf&#34;</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	error <span style="color:#f92672">=</span> <span style="color:#a6e22e">vm_set_topology</span>(ctx, cpu_sockets, cpu_cores, cpu_threads, <span style="color:#ae81ff">0</span>); <span style="color:#75715e">// Set *calculated_topology* in vmm
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (error)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">errx</span>(EX_OSERR, <span style="color:#e6db74">&#34;vm_set_topology&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> (ctx);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The resulting <code>vmctx</code> instance includes file descriptors for the device and control interfaces, memory flags, memory segment information, and the name of the virtual machine.</p>
<ol start="4">
<li>Bootstrap CPU (and initialize others)</li>
</ol>
<p>First, create the bootstrap processor and check the max number of cpus:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>	bsp <span style="color:#f92672">=</span> <span style="color:#a6e22e">vm_vcpu_open</span>(ctx, BSP);
</span></span><span style="display:flex;"><span>	max_vcpus <span style="color:#f92672">=</span> <span style="color:#a6e22e">num_vcpus_allowed</span>(ctx, bsp);
</span></span></code></pre></div><p>How Bhyve checks the number of CPUs:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">num_vcpus_allowed</span>(<span style="color:#66d9ef">struct</span> vmctx <span style="color:#f92672">*</span>ctx, <span style="color:#66d9ef">struct</span> vcpu <span style="color:#f92672">*</span>vcpu)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">uint16_t</span> sockets, cores, threads, maxcpus;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> tmp, error;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * The guest is allowed to spinup more than one processor only if the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * UNRESTRICTED_GUEST capability is available.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 */</span>
</span></span><span style="display:flex;"><span>	error <span style="color:#f92672">=</span> <span style="color:#a6e22e">vm_get_capability</span>(vcpu, VM_CAP_UNRESTRICTED_GUEST, <span style="color:#f92672">&amp;</span>tmp);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (error <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> (<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	error <span style="color:#f92672">=</span> <span style="color:#a6e22e">vm_get_topology</span>(ctx, <span style="color:#f92672">&amp;</span>sockets, <span style="color:#f92672">&amp;</span>cores, <span style="color:#f92672">&amp;</span>threads, <span style="color:#f92672">&amp;</span>maxcpus);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (error <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> (maxcpus);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> (<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Then, Bhyve initializes the bootstrap processor in machine dependent <code>bhyverun_machdep.c</code>. This involves just setting the capabilities for the vcpu. By default, the following two capabilities are set:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>	<span style="color:#a6e22e">vm_set_capability</span>(vcpu, VM_CAP_ENABLE_INVPCID, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	err <span style="color:#f92672">=</span> <span style="color:#a6e22e">vm_set_capability</span>(vcpu, VM_CAP_IPI_EXIT, <span style="color:#ae81ff">1</span>);
</span></span></code></pre></div><ol start="5">
<li>Initializing Virtual Hardware
Initialize per-VCPU resources:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> vcpu_info {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> vmctx	<span style="color:#f92672">*</span>ctx;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> vcpu	<span style="color:#f92672">*</span>vcpu;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span>		vcpuid;
</span></span><span style="display:flex;"><span>} <span style="color:#f92672">*</span>vcpu_info;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Allocate per-VCPU resources. */</span>
</span></span><span style="display:flex;"><span>vcpu_info <span style="color:#f92672">=</span> <span style="color:#a6e22e">calloc</span>(guest_ncpus, <span style="color:#66d9ef">sizeof</span>(<span style="color:#f92672">*</span>vcpu_info));
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> vcpuid <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; vcpuid <span style="color:#f92672">&lt;</span> guest_ncpus; vcpuid<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    vcpu_info[vcpuid].ctx <span style="color:#f92672">=</span> ctx;
</span></span><span style="display:flex;"><span>    vcpu_info[vcpuid].vcpuid <span style="color:#f92672">=</span> vcpuid;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (vcpuid <span style="color:#f92672">==</span> BSP)
</span></span><span style="display:flex;"><span>        vcpu_info[vcpuid].vcpu <span style="color:#f92672">=</span> bsp;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        vcpu_info[vcpuid].vcpu <span style="color:#f92672">=</span> <span style="color:#a6e22e">vm_vcpu_open</span>(ctx, vcpuid);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Setup memory. vm_setup_memory maps the memory to the <code>vmctx</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>	memflags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">get_config_bool_default</span>(<span style="color:#e6db74">&#34;memory.wired&#34;</span>, false))
</span></span><span style="display:flex;"><span>		memflags <span style="color:#f92672">|=</span> VM_MEM_F_WIRED;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">get_config_bool_default</span>(<span style="color:#e6db74">&#34;memory.guest_in_core&#34;</span>, false))
</span></span><span style="display:flex;"><span>		memflags <span style="color:#f92672">|=</span> VM_MEM_F_INCORE;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">vm_set_memflags</span>(ctx, memflags);
</span></span><span style="display:flex;"><span>	error <span style="color:#f92672">=</span> <span style="color:#a6e22e">vm_setup_memory</span>(ctx, memsize, VM_MMAP_ALL);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (error) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Unable to setup memory (%d)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, errno);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></div><p>MMIO features are initialized via the <code>init_mem</code> function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">init_mem</span>(<span style="color:#66d9ef">int</span> ncpu)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	mmio_ncpu <span style="color:#f92672">=</span> ncpu;
</span></span><span style="display:flex;"><span>	mmio_hint <span style="color:#f92672">=</span> <span style="color:#a6e22e">calloc</span>(ncpu, <span style="color:#66d9ef">sizeof</span>(<span style="color:#f92672">*</span>mmio_hint));
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">RB_INIT</span>(<span style="color:#f92672">&amp;</span>mmio_rb_root);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">RB_INIT</span>(<span style="color:#f92672">&amp;</span>mmio_rb_fallback);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pthread_rwlock_init</span>(<span style="color:#f92672">&amp;</span>mmio_rwlock, NULL);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ol start="6">
<li>Initializing other hardware (bootrom and qemu_fwcfg):</li>
</ol>
<p>Bootrom is placed in the high part of the GPA to avoid conflict with guest RAM or low-memory devices</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">init_bootrom</span>(<span style="color:#66d9ef">struct</span> vmctx <span style="color:#f92672">*</span>ctx)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">vm_paddr_t</span> highmem;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	romptr <span style="color:#f92672">=</span> <span style="color:#a6e22e">vm_create_devmem</span>(ctx, VM_BOOTROM, <span style="color:#e6db74">&#34;bootrom&#34;</span>, BOOTROM_SIZE);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (romptr <span style="color:#f92672">==</span> MAP_FAILED)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">err</span>(<span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#34;%s: vm_create_devmem&#34;</span>, __func__);
</span></span><span style="display:flex;"><span>	highmem <span style="color:#f92672">=</span> <span style="color:#a6e22e">vm_get_highmem_base</span>(ctx);
</span></span><span style="display:flex;"><span>	gpa_base <span style="color:#f92672">=</span> highmem <span style="color:#f92672">-</span> BOOTROM_SIZE;
</span></span><span style="display:flex;"><span>	gpa_allocbot <span style="color:#f92672">=</span> gpa_base;
</span></span><span style="display:flex;"><span>	gpa_alloctop <span style="color:#f92672">=</span> highmem <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>QEMU <code>fw cfg</code> gives an interface for passing strings and files into the VM firmware. Operating systems can read configuration data provided by the host without needing disk or network access. Bhyve supports both this qemu fwcfg and also bhyve fwctl. We set the number of hardware CPUs in the guest for the firmware to read.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">qemu_fwcfg_init</span>(ctx) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;qemu fwcfg initialization error</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">qemu_fwcfg_add_file</span>(<span style="color:#e6db74">&#34;opt/bhyve/hw.ncpu&#34;</span>, <span style="color:#66d9ef">sizeof</span>(guest_ncpus),
</span></span><span style="display:flex;"><span>	    <span style="color:#f92672">&amp;</span>guest_ncpus) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Could not add qemu fwcfg opt/bhyve/hw.ncpu</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></div><p>Part 2 will cover initializing the platform.ww</p>
<h2 id="sources">Sources<a href="#sources" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<ul>
<li>Wiki: <a href="https://wiki.freebsd.org/bhyve">https://wiki.freebsd.org/bhyve</a></li>
<li>Bhyvecon: <a href="https://www.youtube.com/watch?v=MTXUZLpCvfg&amp;list=WL&amp;index=4&amp;t=2760s">https://www.youtube.com/watch?v=MTXUZLpCvfg&list=WL&index=4&t=2760s</a></li>
</ul>

      </div></div>

  
    
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="http://localhost:1313/posts/git-fundamentals/">
                <span class="button__icon">←</span>
                <span class="button__text">Git Fundamentals</span>
            </a>
        </span>
        
        
    </div>
</div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2025 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/mirus-ua/hugo-theme-re-terminal" target="_blank">Theme</a> made by <a href="https://github.com/mirus-ua" target="_blank">Mirus</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>








  
</div>

</body>
</html>
